<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Test Automation Dashboard — UChicago Advancement</title>
<style>
:root {
  --maroon:#800000; --maroon-light:#9a1c1c; --maroon-dark:#4d0000;
  --goldenrod:#EAAA00; --goldenrod-dark:#CC8A00; --goldenrod-light:#F3D03E;
  --forest:#275D38; --lake:#007396; --violet:#59315F; --terracotta:#DE7C00;
  --ivy:#789D4A; --brick:#A4343A; --greystone:#767676;
  --bg:#f7f5f2; --bg-card:#fff; --text-dark:#2c2c2c; --text-mid:#555; --text-light:#888; --border:#e0ddd8;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text-dark);min-height:100vh;}

/* Header */
.header{background:var(--maroon);color:#fff;padding:20px 32px 16px;position:relative;}
.header::after{content:'';position:absolute;bottom:0;left:32px;right:32px;height:3px;background:var(--goldenrod);}
.header-top{display:flex;justify-content:space-between;align-items:flex-start;}
.header-tag{font-size:10px;font-weight:600;letter-spacing:2px;color:var(--goldenrod);text-transform:uppercase;margin-bottom:4px;}
.header h1{font-family:'Georgia',serif;font-size:24px;font-weight:700;}
.header-sub{font-size:12px;color:rgba(255,255,255,0.65);margin-top:2px;}
.header-actions{display:flex;gap:6px;align-items:center;flex-shrink:0;}
.header-actions input{width:340px;padding:7px 10px;border-radius:4px;border:none;font-size:10px;font-family:monospace;background:rgba(255,255,255,0.15);color:#fff;}
.header-actions input::placeholder{color:rgba(255,255,255,0.45);}
.header-actions input:focus{outline:none;background:rgba(255,255,255,0.25);}
.btn{padding:7px 14px;border:none;border-radius:4px;font-weight:600;cursor:pointer;font-size:12px;transition:background 0.2s;}
.btn-gold{background:var(--goldenrod);color:var(--maroon);}
.btn-gold:hover{background:var(--goldenrod-dark);}
.btn-config{background:rgba(255,255,255,0.15);color:#fff;font-size:11px;}
.btn-config:hover{background:rgba(255,255,255,0.25);}

/* Config */
#configPanel{display:none;background:rgba(0,0,0,0.15);padding:12px 32px;border-bottom:1px solid rgba(255,255,255,0.1);}
#configPanel.open{display:flex;gap:16px;align-items:center;background:var(--maroon-dark);}
#configPanel label{color:rgba(255,255,255,0.7);font-size:11px;font-weight:600;}
#configPanel input{padding:6px 10px;border-radius:4px;border:none;font-size:12px;width:80px;background:rgba(255,255,255,0.15);color:#fff;}
#configPanel input:focus{outline:none;background:rgba(255,255,255,0.25);}

.content{padding:24px 32px;}

/* KPI */
.kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px;}
.kpi{background:var(--bg-card);border-radius:8px;padding:16px 18px;border:1px solid var(--border);position:relative;overflow:hidden;}
.kpi .bar{position:absolute;top:0;left:0;right:0;height:4px;}
.kpi .lbl{font-size:11px;color:var(--text-light);font-weight:600;text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px;}
.kpi .val{font-size:32px;font-weight:700;font-family:'Georgia',serif;}
.kpi .sub{font-size:11px;color:var(--text-light);margin-top:2px;}

/* Progress */
.progress-panel{background:var(--bg-card);border-radius:8px;padding:18px 20px;border:1px solid var(--border);margin-bottom:20px;}
.progress-panel .title{font-size:13px;font-weight:700;color:var(--maroon);margin-bottom:12px;}
.prog-row{margin-bottom:10px;}
.prog-label{display:flex;justify-content:space-between;font-size:12px;color:var(--text-mid);margin-bottom:4px;}
.prog-track{height:20px;background:#f0ece6;border-radius:4px;overflow:hidden;}
.prog-fill{height:100%;border-radius:4px;transition:width .4s;}

/* Category breakdown */
.cat-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px;}
.cat-panel{background:var(--bg-card);border-radius:8px;padding:18px 20px;border:1px solid var(--border);}
.cat-panel .title{font-size:13px;font-weight:700;color:var(--maroon);margin-bottom:12px;border-bottom:1px solid var(--border);padding-bottom:6px;}
.cat-row{margin-bottom:10px;}
.cat-lbl{display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;}
.cat-track{display:flex;height:14px;border-radius:4px;overflow:hidden;background:#f0ece6;}
.cat-legend{display:flex;gap:14px;margin-top:12px;font-size:10px;color:var(--text-light);border-top:1px solid var(--border);padding-top:8px;}
.cat-legend i{display:inline-block;width:10px;height:10px;border-radius:2px;margin-right:4px;vertical-align:middle;}

/* Scenario List */
.list-section{background:var(--bg-card);border-radius:8px;border:1px solid var(--border);overflow:hidden;margin-bottom:20px;}
.list-toolbar{display:flex;gap:8px;align-items:center;padding:14px 18px;border-bottom:1px solid var(--border);flex-wrap:wrap;}
.search-input{flex:1;min-width:200px;padding:8px 12px;border:1px solid var(--border);border-radius:4px;font-size:13px;background:var(--bg);}
.search-input:focus{outline:none;border-color:var(--maroon);}
.filter-btn{padding:6px 12px;border:1px solid var(--border);border-radius:20px;font-size:11px;font-weight:600;cursor:pointer;background:var(--bg);color:var(--text-mid);transition:all .2s;}
.filter-btn:hover{border-color:var(--maroon);color:var(--maroon);}
.filter-btn.active{background:var(--maroon);color:#fff;border-color:var(--maroon);}
.filter-btn .count{display:inline-block;background:rgba(0,0,0,0.1);border-radius:10px;padding:1px 6px;margin-left:4px;font-size:10px;}
.filter-btn.active .count{background:rgba(255,255,255,0.25);}

/* Table */
.s-table{width:100%;border-collapse:collapse;}
.s-table th{text-align:left;padding:10px 14px;font-size:11px;font-weight:600;color:var(--text-light);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border);background:#faf8f5;cursor:pointer;user-select:none;white-space:nowrap;}
.s-table th:hover{color:var(--maroon);}
.s-table td{padding:10px 14px;font-size:13px;border-bottom:1px solid #f0ece6;vertical-align:middle;}
.s-table tr:hover{background:#faf8f5;cursor:pointer;}
.s-table tr.planned-row{background:#fef9eb;}
.s-table tr.planned-row:hover{background:#fdf0d0;}

/* Badges */
.badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;}
.badge-auto{background:#e8f5e9;color:var(--forest);}
.badge-manual{background:#f0ece6;color:var(--greystone);}
.badge-pending{background:#fef9eb;color:var(--goldenrod-dark);}
.badge-planned{background:var(--goldenrod);color:var(--maroon);font-size:10px;padding:2px 8px;margin-left:6px;}
.risk-dot{display:inline-block;width:28px;height:28px;line-height:28px;text-align:center;border-radius:50%;font-size:11px;font-weight:700;color:#fff;}
.risk-high{background:var(--brick);}
.risk-med{background:var(--goldenrod-dark);}
.risk-low{background:var(--ivy);}

/* Detail View */
.detail-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);z-index:200;justify-content:center;align-items:start;padding:40px;}
.detail-overlay.open{display:flex;}
.detail-card{background:#fff;border-radius:10px;width:720px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.25);}
.detail-header{background:var(--maroon);color:#fff;padding:20px 24px;border-radius:10px 10px 0 0;position:relative;}
.detail-header h2{font-family:'Georgia',serif;font-size:18px;padding-right:40px;}
.detail-header .grp{font-size:11px;color:var(--goldenrod);margin-bottom:4px;font-weight:600;text-transform:uppercase;letter-spacing:1px;}
.detail-close{position:absolute;top:16px;right:20px;background:none;border:none;color:#fff;font-size:24px;cursor:pointer;opacity:0.7;}
.detail-close:hover{opacity:1;}
.detail-body{padding:24px;}
.detail-desc{font-size:14px;color:var(--text-mid);margin-bottom:20px;line-height:1.5;padding:12px 16px;background:#faf8f5;border-left:3px solid var(--maroon);border-radius:0 4px 4px 0;}
.detail-section{margin-bottom:20px;}
.detail-section h3{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--maroon);margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid var(--border);}
.detail-steps{font-size:13px;line-height:1.7;color:var(--text-dark);white-space:pre-wrap;padding:12px 16px;background:#faf8f5;border-radius:6px;}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.detail-field{padding:10px 14px;background:#faf8f5;border-radius:6px;}
.detail-field .df-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-light);margin-bottom:2px;}
.detail-field .df-value{font-size:14px;font-weight:600;color:var(--text-dark);}
.detail-field a{color:var(--lake);text-decoration:none;}
.detail-field a:hover{text-decoration:underline;}
.detail-badges{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px;}

/* Status bar */
.status-bar{padding:12px 32px;background:#fef9eb;border-bottom:1px solid var(--border);font-size:12px;color:var(--goldenrod-dark);display:none;}
.status-bar.show{display:block;}
.status-bar.error{background:#fde8e8;color:var(--brick);}
.loading{text-align:center;padding:60px;font-size:14px;color:var(--text-light);}
.loading .spinner{display:inline-block;width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--maroon);border-radius:50%;animation:spin .6s linear infinite;margin-bottom:12px;}
@keyframes spin{to{transform:rotate(360deg)}}

.empty{text-align:center;padding:40px;color:var(--text-light);font-size:13px;}

/* Footer */
.footer{padding:12px 32px;font-size:10px;color:var(--text-light);border-top:1px solid var(--border);display:flex;justify-content:space-between;}

@media print{.header-actions,.btn-config,#configPanel,.search-input,.filter-btn,.detail-overlay{display:none!important;}}
@media(max-width:900px){.kpi-grid{grid-template-columns:1fr;}.cat-grid{grid-template-columns:1fr;}.detail-card{width:95%;}}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-top">
    <div>
      <div class="header-tag">QA Test Management</div>
      <h1>Test Automation Dashboard</h1>
      <div class="header-sub">University of Chicago Advancement · Copado Robotic Testing (CRT)</div>
    </div>
    <div class="header-actions">
      <input type="text" id="sheetUrl" placeholder="Google Sheet CSV URL (base, no gid)..." value="https://docs.google.com/spreadsheets/d/e/2PACX-1vRoGV-kjbZw4zZrS-zS3HWuqDf-bGuy4Cgi84V10UR6Np6ZhHZ-S27hhHVgVlV82IIY0ltQ9LuCzZEf/pub?output=csv">
      <button class="btn btn-gold" onclick="loadSheet()">↻ Load</button>
      <button class="btn btn-gold" onclick="autoLoad()" style="background:var(--forest);color:#fff">▶ Auto</button>
      <button class="btn btn-config" onclick="toggleConfig()">⚙</button>
    </div>
  </div>
</div>

<!-- Config -->
<div id="configPanel">
  <label>Baseline Goal:</label>
  <input type="number" id="cfgBaseline" value="60">
  <button class="btn btn-gold" onclick="renderAll()">Apply</button>
</div>

<!-- Status -->
<div id="statusBar" class="status-bar"></div>

<!-- Content -->
<div class="content" id="mainContent">
  <div class="loading"><div class="spinner"></div><br>Enter your Google Sheet CSV URL and click Load</div>
</div>

<!-- Detail Overlay -->
<div class="detail-overlay" id="detailOverlay" onclick="if(event.target===this)closeDetail()">
  <div class="detail-card">
    <div class="detail-header">
      <span class="grp" id="detGrp"></span>
      <h2 id="detTitle"></h2>
      <button class="detail-close" onclick="closeDetail()">✕</button>
    </div>
    <div class="detail-body" id="detBody"></div>
  </div>
</div>

<script>
/* ============================================================
   CONFIG & STATE
   ============================================================ */
let DATA = [];
let FILTERED = [];
let ACTIVE_GROUP = 'All';
let SEARCH = '';
let SORT_COL = null;
let SORT_DIR = 1;

const GROUP_COLORS = {
  "Alumni & Friends Portal":"#007396","Constituent Management":"#59315F",
  "Gift Admin":"#275D38","Prospect Research":"#EAAA00","Events":"#DE7C00",
  "Marketing & Communication":"#789D4A","Prospect Management/Gift Officer":"#A4343A"
};
function gc(g){return GROUP_COLORS[g]||"#767676";}

/* ============================================================
   CSV PARSING
   ============================================================ */
function parseCSV(text){
  const lines=[];let cur='',inQ=false,row=[];
  for(let i=0;i<text.length;i++){
    const c=text[i],n=text[i+1];
    if(inQ){if(c==='"'&&n==='"'){cur+='"';i++;}else if(c==='"'){inQ=false;}else{cur+=c;}}
    else{if(c==='"'){inQ=true;}else if(c===','){row.push(cur.trim());cur='';}else if(c==='\n'||(c==='\r'&&n==='\n')){if(c==='\r')i++;row.push(cur.trim());lines.push(row);row=[];cur='';}else{cur+=c;}}
  }
  if(cur||row.length){row.push(cur.trim());lines.push(row);}
  return lines;
}

function csvToObjects(text){
  const lines=parseCSV(text);
  if(lines.length<2)return[];
  const hdr=lines[0].map(h=>h.replace(/^\uFEFF/,'').trim());
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const r=lines[i];if(!r||r.every(c=>!c))continue;
    const obj={};
    hdr.forEach((h,j)=>{obj[h]=r[j]||'';});
    rows.push(obj);
  }
  return rows;
}

/* ============================================================
   LOAD SHEET
   ============================================================ */
const SHEET_GIDS = ['0', '1486981684'];

async function fetchCSV(url){
  const methods=[
    ()=>fetch(url),
    ()=>fetch('https://corsproxy.io/?'+encodeURIComponent(url)),
    ()=>fetch('https://api.allorigins.win/raw?url='+encodeURIComponent(url)),
  ];
  for(let i=0;i<methods.length;i++){
    try{
      const resp=await methods[i]();
      if(!resp.ok)throw new Error('HTTP '+resp.status);
      const text=await resp.text();
      if(!text||text.length<10)throw new Error('Empty');
      return text;
    }catch(e){if(i===methods.length-1)throw e;}
  }
}

async function loadSheet(){
  const baseUrl=document.getElementById('sheetUrl').value.trim();
  if(!baseUrl){showStatus('Please enter a Google Sheet CSV URL','error');return;}
  document.getElementById('mainContent').innerHTML='<div class="loading"><div class="spinner"></div><br>Loading from Google Sheets ('+SHEET_GIDS.length+' tabs)...</div>';

  try{
    let allRows=[];
    for(const gid of SHEET_GIDS){
      const url=baseUrl.includes('gid=')?baseUrl:baseUrl+(baseUrl.includes('?')?'&':'?')+'gid='+gid;
      try{
        const text=await fetchCSV(url);
        const rows=csvToObjects(text);
        allRows=allRows.concat(rows);
      }catch(e){
        console.warn('Could not load tab gid='+gid+': '+e.message);
      }
    }

    // Deduplicate by Process Name / User Story
    const seen=new Set();
    DATA=[];
    allRows.forEach(r=>{
      const key=(r['Process Name / User Story']||'').trim().toLowerCase();
      if(key&&seen.has(key))return;
      if(key)seen.add(key);
      DATA.push(r);
    });

    if(!DATA.length)throw new Error('No data rows found');
    showStatus('Loaded '+DATA.length+' scenarios from '+SHEET_GIDS.length+' tabs (deduplicated)','ok');
    renderAll();
  }catch(e){
    showStatus('Error loading sheet: '+e.message,'error');
    document.getElementById('mainContent').innerHTML=`<div class="loading" style="max-width:600px;margin:0 auto;text-align:left">
      <p style="margin-bottom:16px">⚠ <strong>Could not fetch the Google Sheet directly.</strong></p>
      <p style="margin-bottom:12px;font-size:13px;color:var(--text-mid)">This is usually a CORS restriction. Try these options:</p>
      <ol style="font-size:13px;color:var(--text-mid);padding-left:20px;line-height:2">
        <li>Open your CSV URL in a browser tab, <strong>Select All → Copy</strong> the text, then paste it into the box below</li>
        <li>Or download the CSV and drag it onto this page</li>
      </ol>
      <textarea id="manualCsv" placeholder="Paste CSV data here..." style="width:100%;height:120px;margin-top:12px;padding:10px;border:1px solid var(--border);border-radius:6px;font-family:monospace;font-size:11px;"></textarea>
      <button class="btn btn-gold" style="margin-top:8px" onclick="loadManual()">Load Pasted Data</button>
      <div style="margin-top:16px;padding:12px;background:#faf8f5;border-radius:6px;font-size:11px;color:var(--text-light)">
        <strong>Tip:</strong> Once deployed to a web server, the direct fetch will work. CORS only blocks local HTML files.
      </div>
    </div>`;
  }
}

function loadManual(){
  const text=document.getElementById('manualCsv').value.trim();
  if(!text){showStatus('Please paste CSV data first','error');return;}
  try{
    DATA=csvToObjects(text);
    if(!DATA.length)throw new Error('No data rows found');
    showStatus('Loaded '+DATA.length+' scenarios from pasted data','ok');
    renderAll();
  }catch(e){
    showStatus('Error parsing data: '+e.message,'error');
  }
}

function showStatus(msg,type){
  const bar=document.getElementById('statusBar');
  bar.textContent=msg;bar.className='status-bar show'+(type==='error'?' error':'');
  if(type!=='error')setTimeout(()=>{bar.className='status-bar';},4000);
}

function toggleConfig(){document.getElementById('configPanel').classList.toggle('open');}

/* ============================================================
   CALCULATIONS
   ============================================================ */
function getExec(r){return(r['Execution']||'').trim();}
function getGroup(r){return(r['Group']||'Unknown').trim();}
function getRisk(r){return parseFloat(r['Risk Average'])||0;}
function isPlanned(r){const v=(r['Planned']||'').toString().trim().toLowerCase();return v==='true'||v==='yes'||v==='1';}
function getStatus(r){return(r['Status']||'').trim();}
function getToDo(r){return(r['To Do']||'').trim();}

function calcStats(){
  const baseline=parseInt(document.getElementById('cfgBaseline').value)||60;
  const total=DATA.length;
  const automated=DATA.filter(r=>getExec(r)==='Automated').length;
  const manual=DATA.filter(r=>getExec(r)==='Manual').length;
  const pending=DATA.filter(r=>getExec(r)==='Pending').length;
  const planned=DATA.filter(r=>isPlanned(r)).length;
  const pct=baseline>0?Math.round((automated/baseline)*100):0;

  const groups={};
  DATA.forEach(r=>{
    const g=getGroup(r);
    if(!groups[g])groups[g]={total:0,automated:0,manual:0,pending:0,planned:0};
    groups[g].total++;
    const ex=getExec(r);
    if(ex==='Automated')groups[g].automated++;
    else if(ex==='Manual')groups[g].manual++;
    else if(ex==='Pending')groups[g].pending++;
    if(isPlanned(r))groups[g].planned++;
  });

  return{baseline,total,automated,manual,pending,planned,pct,groups};
}

/* ============================================================
   FILTERING & SORTING
   ============================================================ */
function applyFilters(){
  FILTERED=DATA.filter(r=>{
    if(ACTIVE_GROUP!=='All'&&getGroup(r)!==ACTIVE_GROUP)return false;
    if(SEARCH){
      const s=SEARCH.toLowerCase();
      const hay=[(r['Process Name / User Story']||''),(r['Group']||''),(r['Description']||''),(r['Status']||''),(r['Execution']||''),(r['To Do']||''),(r['Notes']||'')].join(' ').toLowerCase();
      if(!hay.includes(s))return false;
    }
    return true;
  });
  if(SORT_COL){
    FILTERED.sort((a,b)=>{
      let va=a[SORT_COL]||'',vb=b[SORT_COL]||'';
      const na=parseFloat(va),nb=parseFloat(vb);
      if(!isNaN(na)&&!isNaN(nb))return(na-nb)*SORT_DIR;
      return va.localeCompare(vb)*SORT_DIR;
    });
  }
}

function setGroup(g){ACTIVE_GROUP=g;applyFilters();renderList();}
function setSearch(v){SEARCH=v;applyFilters();renderList();}
function setSort(col){if(SORT_COL===col)SORT_DIR*=-1;else{SORT_COL=col;SORT_DIR=1;}applyFilters();renderList();}

/* ============================================================
   RENDER ALL
   ============================================================ */
function renderAll(){
  const s=calcStats();
  applyFilters();

  const groupNames=Object.keys(s.groups).sort();
  const maxGrp=Math.max(...groupNames.map(g=>s.groups[g].total),1);

  let html='';

  // KPIs
  html+=`<div class="kpi-grid">
    <div class="kpi"><div class="bar" style="background:var(--maroon)"></div>
      <div class="lbl">Baseline Goal</div><div class="val" style="color:var(--maroon)">${s.baseline}</div>
      <div class="sub">Revised target scenarios</div></div>
    <div class="kpi"><div class="bar" style="background:var(--forest)"></div>
      <div class="lbl">Currently Automated</div><div class="val" style="color:var(--forest)">${s.automated}</div>
      <div class="sub">${s.pct}% of baseline · ${s.total} total scenarios tracked</div></div>
    <div class="kpi"><div class="bar" style="background:var(--goldenrod)"></div>
      <div class="lbl">Pipeline</div><div class="val" style="color:var(--goldenrod-dark)">${s.manual+s.pending}</div>
      <div class="sub">${s.manual} manual · ${s.pending} pending · ${s.planned} planned</div></div>
  </div>`;

  // Progress
  const autoW=Math.min(s.pct,100);
  const pendW=Math.min(Math.round(((s.automated+s.pending)/s.baseline)*100),100)-autoW;
  html+=`<div class="progress-panel">
    <div class="title">Progress Toward Baseline (${s.baseline})</div>
    <div class="prog-row">
      <div class="prog-label"><span><strong style="color:var(--forest)">${s.automated} automated</strong> + ${s.pending} pending of ${s.baseline} baseline</span><strong style="color:var(--forest)">${s.pct}%</strong></div>
      <div class="prog-track" style="display:flex">
        <div class="prog-fill" style="width:${autoW}%;background:var(--forest)"></div>
        <div class="prog-fill" style="width:${pendW}%;background:var(--goldenrod);opacity:0.5"></div>
      </div>
    </div>
    <div style="margin-top:8px;font-size:11px;color:var(--text-light);display:flex;gap:16px;">
      <span><i style="display:inline-block;width:10px;height:10px;background:var(--forest);border-radius:2px;vertical-align:middle;margin-right:4px;"></i>Automated</span>
      <span><i style="display:inline-block;width:10px;height:10px;background:var(--goldenrod);opacity:0.5;border-radius:2px;vertical-align:middle;margin-right:4px;"></i>Pending</span>
    </div>
  </div>`;

  // Category Breakdown
  html+=`<div class="cat-grid">
    <div class="cat-panel"><div class="title">Scenarios by Group</div>`;
  groupNames.forEach(g=>{
    const d=s.groups[g];const color=gc(g);
    const aw=(d.automated/maxGrp)*90;const mw=(d.manual/maxGrp)*90;const pw=(d.pending/maxGrp)*90;
    html+=`<div class="cat-row">
      <div class="cat-lbl"><span style="color:${color};font-weight:600">${g}</span><span style="color:var(--text-mid)">${d.total} total</span></div>
      <div class="cat-track">
        ${d.automated?`<div style="width:${aw}%;background:${color};border-radius:4px 0 0 4px"></div>`:''}
        ${d.manual?`<div style="width:${mw}%;background:${color}44"></div>`:''}
        ${d.pending?`<div style="width:${pw}%;background:${color}22;border-right:2px dashed ${color}"></div>`:''}
      </div>
    </div>`;
  });
  html+=`<div class="cat-legend"><span><i style="background:var(--greystone)"></i> Automated</span><span><i style="background:rgba(118,118,118,0.27)"></i> Manual</span><span><i style="background:rgba(118,118,118,0.13);border:1px dashed var(--greystone)"></i> Pending</span></div></div>`;

  // Automation by Group
  html+=`<div class="cat-panel"><div class="title">Automation Rate by Group</div>`;
  groupNames.forEach(g=>{
    const d=s.groups[g];const color=gc(g);
    const rate=d.total>0?Math.round((d.automated/d.total)*100):0;
    html+=`<div class="cat-row">
      <div class="cat-lbl"><span style="color:${color};font-weight:600">${g}</span><span style="font-weight:600;color:${rate>=60?'var(--forest)':rate>=30?'var(--goldenrod-dark)':'var(--brick)'}">${rate}%</span></div>
      <div class="cat-track"><div style="width:${rate}%;background:${color};border-radius:4px;height:100%"></div></div>
    </div>`;
  });
  html+=`</div></div>`;

  // Scenario List
  const groupCounts={};
  DATA.forEach(r=>{const g=getGroup(r);groupCounts[g]=(groupCounts[g]||0)+1;});

  html+=`<div class="list-section">
    <div class="list-toolbar">
      <input class="search-input" type="text" placeholder="Search scenarios..." oninput="setSearch(this.value)" value="${SEARCH}">
      <button class="filter-btn ${ACTIVE_GROUP==='All'?'active':''}" onclick="setGroup('All')">All<span class="count">${DATA.length}</span></button>`;
  groupNames.forEach(g=>{
    html+=`<button class="filter-btn ${ACTIVE_GROUP===g?'active':''}" onclick="setGroup('${g.replace(/'/g,"\\'")}')">${g}<span class="count">${groupCounts[g]||0}</span></button>`;
  });
  html+=`</div><div id="listBody"></div></div>`;

  // Footer
  html+=`<div class="footer"><span>Copado Robotic Testing (CRT) · Live from Google Sheets</span><span>Last loaded: ${new Date().toLocaleString()}</span></div>`;

  document.getElementById('mainContent').innerHTML=html;
  renderList();
}

/* ============================================================
   RENDER LIST
   ============================================================ */
function renderList(){
  const body=document.getElementById('listBody');
  if(!body)return;

  if(!FILTERED.length){body.innerHTML='<div class="empty">No scenarios match your filters</div>';return;}

  const arrow=col=>SORT_COL===col?(SORT_DIR===1?' ▲':' ▼'):'';

  let t=`<table class="s-table"><thead><tr>
    <th onclick="setSort('Process Name / User Story')">Process Name${arrow('Process Name / User Story')}</th>
    <th onclick="setSort('Group')">Group${arrow('Group')}</th>
    <th onclick="setSort('Execution')">Execution${arrow('Execution')}</th>
    <th onclick="setSort('Risk Average')">Risk${arrow('Risk Average')}</th>
    <th onclick="setSort('Status')">Status${arrow('Status')}</th>
    <th onclick="setSort('To Do')">To Do${arrow('To Do')}</th>
    <th onclick="setSort('Sprint')">Sprint${arrow('Sprint')}</th>
  </tr></thead><tbody>`;

  FILTERED.forEach((r,i)=>{
    const ex=getExec(r);
    const risk=getRisk(r);
    const pl=isPlanned(r);
    const badgeCls=ex==='Automated'?'badge-auto':ex==='Pending'?'badge-pending':'badge-manual';
    const riskCls=risk>=2.5?'risk-high':risk>=1.75?'risk-med':'risk-low';
    const sprint=(r['Sprint']||'').trim();
    const sprintDisplay=sprint?(sprint.startsWith('http')?'<a href="'+sprint+'" target="_blank" onclick="event.stopPropagation()" style="color:var(--lake)">View</a>':sprint):'—';

    t+=`<tr class="${pl?'planned-row':''}" onclick="showDetail(${i})">
      <td><strong>${r['Process Name / User Story']||''}</strong>${pl?'<span class="badge badge-planned">PLANNED</span>':''}</td>
      <td style="color:${gc(getGroup(r))};font-weight:600;font-size:12px">${getGroup(r)}</td>
      <td><span class="badge ${badgeCls}">${ex||'—'}</span></td>
      <td><span class="risk-dot ${riskCls}">${risk}</span></td>
      <td style="font-size:12px">${getStatus(r)||'—'}</td>
      <td style="font-size:12px">${getToDo(r)||'—'}</td>
      <td style="font-size:12px">${sprintDisplay}</td>
    </tr>`;
  });
  t+='</tbody></table>';
  body.innerHTML=t;
}

/* ============================================================
   DETAIL VIEW
   ============================================================ */
function showDetail(idx){
  const r=FILTERED[idx];if(!r)return;
  document.getElementById('detGrp').textContent=getGroup(r);
  document.getElementById('detTitle').textContent=r['Process Name / User Story']||'';

  const ex=getExec(r);const badgeCls=ex==='Automated'?'badge-auto':ex==='Pending'?'badge-pending':'badge-manual';
  const risk=getRisk(r);const riskCls=risk>=3?'risk-high':risk>=2.75?'risk-med':'risk-low';

  let h='';

  // Badges
  h+=`<div class="detail-badges">
    <span class="badge ${badgeCls}">${ex||'—'}</span>
    ${isPlanned(r)?'<span class="badge badge-planned">PLANNED</span>':''}
    <span class="risk-dot ${riskCls}" style="font-size:10px;width:auto;padding:4px 10px;border-radius:12px;">Risk: ${risk}</span>
  </div>`;

  // Description
  const desc=(r['Description']||'').trim();
  if(desc)h+=`<div class="detail-desc">${desc}</div>`;

  // Test Steps
  const steps=(r['Test Steps']||'').trim();
  if(steps){h+=`<div class="detail-section"><h3>Test Steps</h3><div class="detail-steps">${steps.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div></div>`;}

  // Risk Fields
  h+=`<div class="detail-section"><h3>Risk Assessment</h3><div class="detail-grid">
    <div class="detail-field"><div class="df-label">Frequency of Use</div><div class="df-value">${r['Frequency of Use']||'—'}</div></div>
    <div class="detail-field"><div class="df-label">Business Impact</div><div class="df-value">${r['Business Impact']||'—'}</div></div>
    <div class="detail-field"><div class="df-label">Process Complexity</div><div class="df-value">${r['Process Complexity']||'—'}</div></div>
    <div class="detail-field"><div class="df-label">Technical Impact</div><div class="df-value">${r['Technical Impact']||'—'}</div></div>
  </div></div>`;

  // Status & Workflow
  h+=`<div class="detail-section"><h3>Workflow</h3><div class="detail-grid">
    <div class="detail-field"><div class="df-label">Status</div><div class="df-value">${getStatus(r)||'—'}</div></div>
    <div class="detail-field"><div class="df-label">To Do</div><div class="df-value">${getToDo(r)||'—'}</div></div>
    <div class="detail-field"><div class="df-label">Execution</div><div class="df-value">${ex||'—'}</div></div>
    <div class="detail-field"><div class="df-label">Sprint</div><div class="df-value">${(()=>{const s=(r['Sprint']||'').trim();return s?(s.startsWith('http')?'<a href="'+s+'" target="_blank">View Sprint</a>':s):'—';})()}</div></div>
  </div></div>`;

  // Links
  const workId=(r['Work ID']||'').trim();
  const notes=(r['Notes']||'').trim();
  if(workId||notes){
    h+=`<div class="detail-section"><h3>References</h3><div class="detail-grid">`;
    if(workId)h+=`<div class="detail-field"><div class="df-label">Work ID</div><div class="df-value">${workId.startsWith('http')?'<a href="'+workId+'" target="_blank">Open in CRT</a>':workId}</div></div>`;
    if(notes)h+=`<div class="detail-field"><div class="df-label">Notes</div><div class="df-value">${notes}</div></div>`;
    h+=`</div></div>`;
  }

  document.getElementById('detBody').innerHTML=h;
  document.getElementById('detailOverlay').classList.add('open');
  document.body.style.overflow='hidden';
}

function closeDetail(){
  document.getElementById('detailOverlay').classList.remove('open');
  document.body.style.overflow='';
}

document.addEventListener('keydown',e=>{if(e.key==='Escape')closeDetail();});

// Auto-load on page open
function autoLoad(){loadSheet();}
window.addEventListener('DOMContentLoaded',()=>{loadSheet();});
</script>
</body>
</html>
