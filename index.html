<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Test Automation Dashboard — UChicago Advancement</title>
<style>
:root {
  --maroon: #800000;
  --maroon-light: #9a1c1c;
  --maroon-dark: #4d0000;
  --goldenrod: #EAAA00;
  --goldenrod-dark: #CC8A00;
  --forest: #275D38;
  --lake: #007396;
  --violet: #59315F;
  --terracotta: #DE7C00;
  --ivy: #789D4A;
  --brick: #A4343A;
  --greystone: #767676;
  --bg: #f7f5f2;
  --bg-card: #ffffff;
  --text-dark: #2c2c2c;
  --text-mid: #555555;
  --text-light: #888888;
  --border: #e0ddd8;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Segoe UI', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text-dark);
  min-height: 100vh;
}

/* HEADER */
.header {
  background: var(--maroon);
  color: #fff;
  padding: 20px 32px 16px;
  position: relative;
}
.header::after {
  content: '';
  position: absolute;
  bottom: 0; left: 32px; right: 32px;
  height: 3px;
  background: var(--goldenrod);
}
.header-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}
.header-tag {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 2px;
  color: var(--goldenrod);
  text-transform: uppercase;
  margin-bottom: 4px;
}
.header h1 {
  font-family: Georgia, serif;
  font-size: 24px;
  font-weight: 700;
}
.header-sub {
  font-size: 12px;
  color: rgba(255,255,255,0.65);
  margin-top: 2px;
}
.header-actions {
  display: flex;
  gap: 6px;
  align-items: center;
}
.btn {
  padding: 7px 14px;
  border: none;
  border-radius: 4px;
  font-weight: 600;
  cursor: pointer;
  font-size: 12px;
}
.btn-gold { background: var(--goldenrod); color: var(--maroon); }
.btn-gold:hover { background: var(--goldenrod-dark); }
.btn-config { background: rgba(255,255,255,0.15); color: #fff; font-size: 11px; }
.btn-config:hover { background: rgba(255,255,255,0.25); }
.btn-forest { background: var(--forest); color: #fff; }
.btn-forest:hover { background: #1e4a2b; }

/* CONFIG PANEL */
#configPanel {
  display: none;
  background: var(--maroon-dark);
  padding: 12px 32px;
}
#configPanel.open {
  display: flex;
  gap: 16px;
  align-items: center;
}
#configPanel label {
  color: rgba(255,255,255,0.7);
  font-size: 11px;
  font-weight: 600;
}
#configPanel input {
  padding: 6px 10px;
  border-radius: 4px;
  border: none;
  font-size: 12px;
  width: 80px;
  background: rgba(255,255,255,0.15);
  color: #fff;
}

/* RISK FILTER BAR */
.risk-bar {
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  padding: 10px 32px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.risk-bar-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-light);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-right: 4px;
}
.risk-btn {
  padding: 5px 14px;
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  background: var(--bg);
  color: var(--text-mid);
}
.risk-btn:hover {
  border-color: var(--maroon);
  color: var(--maroon);
}
.risk-btn.active {
  color: #fff;
  border-color: transparent;
}
.risk-btn.active[data-risk="all"] { background: var(--maroon); }
.risk-btn.active[data-risk="high"] { background: var(--brick); }
.risk-btn.active[data-risk="medium"] { background: var(--goldenrod-dark); }
.risk-btn.active[data-risk="low"] { background: var(--ivy); }

/* CONTENT */
.content { padding: 24px 32px; }

/* KPI CARDS */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 14px;
  margin-bottom: 20px;
}
.kpi {
  background: var(--bg-card);
  border-radius: 8px;
  padding: 16px 18px;
  border: 1px solid var(--border);
  position: relative;
  overflow: hidden;
}
.kpi .bar {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 4px;
}
.kpi .lbl {
  font-size: 11px;
  color: var(--text-light);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 4px;
}
.kpi .val {
  font-size: 32px;
  font-weight: 700;
  font-family: Georgia, serif;
}
.kpi .sub {
  font-size: 11px;
  color: var(--text-light);
  margin-top: 2px;
}

/* PROGRESS */
.progress-panel {
  background: var(--bg-card);
  border-radius: 8px;
  padding: 18px 20px;
  border: 1px solid var(--border);
  margin-bottom: 20px;
}
.progress-panel .title {
  font-size: 13px;
  font-weight: 700;
  color: var(--maroon);
  margin-bottom: 12px;
}
.prog-label {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: var(--text-mid);
  margin-bottom: 4px;
}
.prog-track {
  height: 20px;
  background: #f0ece6;
  border-radius: 4px;
  overflow: hidden;
  display: flex;
}
.prog-fill {
  height: 100%;
  border-radius: 4px;
}
.prog-legend {
  margin-top: 8px;
  font-size: 11px;
  color: var(--text-light);
  display: flex;
  gap: 16px;
}
.prog-legend i {
  display: inline-block;
  width: 10px; height: 10px;
  border-radius: 2px;
  vertical-align: middle;
  margin-right: 4px;
}

/* CATEGORY PANELS */
.cat-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
  margin-bottom: 20px;
}
.cat-panel {
  background: var(--bg-card);
  border-radius: 8px;
  padding: 18px 20px;
  border: 1px solid var(--border);
}
.cat-panel .title {
  font-size: 13px;
  font-weight: 700;
  color: var(--maroon);
  margin-bottom: 12px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 6px;
}
.cat-row { margin-bottom: 10px; }
.cat-lbl {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  margin-bottom: 4px;
}
.cat-track {
  display: flex;
  height: 14px;
  border-radius: 4px;
  overflow: hidden;
  background: #f0ece6;
}
.cat-legend {
  display: flex;
  gap: 14px;
  margin-top: 12px;
  font-size: 10px;
  color: var(--text-light);
  border-top: 1px solid var(--border);
  padding-top: 8px;
}
.cat-legend i {
  display: inline-block;
  width: 10px; height: 10px;
  border-radius: 2px;
  margin-right: 4px;
  vertical-align: middle;
}

/* SCENARIO LIST */
.list-section {
  background: var(--bg-card);
  border-radius: 8px;
  border: 1px solid var(--border);
  overflow: hidden;
  margin-bottom: 20px;
}
.list-toolbar {
  display: flex;
  gap: 8px;
  align-items: center;
  padding: 14px 18px;
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
}
.search-input {
  flex: 1;
  min-width: 200px;
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: 4px;
  font-size: 13px;
  background: var(--bg);
}
.search-input:focus {
  outline: none;
  border-color: var(--maroon);
}
.filter-btn {
  padding: 6px 12px;
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  background: var(--bg);
  color: var(--text-mid);
}
.filter-btn:hover {
  border-color: var(--maroon);
  color: var(--maroon);
}
.filter-btn.active {
  background: var(--maroon);
  color: #fff;
  border-color: var(--maroon);
}
.filter-btn .ct {
  display: inline-block;
  background: rgba(0,0,0,0.1);
  border-radius: 10px;
  padding: 1px 6px;
  margin-left: 4px;
  font-size: 10px;
}
.filter-btn.active .ct {
  background: rgba(255,255,255,0.25);
}

/* TABLE */
.s-table {
  width: 100%;
  border-collapse: collapse;
}
.s-table th {
  text-align: left;
  padding: 10px 14px;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-light);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 2px solid var(--border);
  background: #faf8f5;
  cursor: pointer;
  user-select: none;
  white-space: nowrap;
}
.s-table th:hover { color: var(--maroon); }
.s-table td {
  padding: 10px 14px;
  font-size: 13px;
  border-bottom: 1px solid #f0ece6;
  vertical-align: middle;
}
.s-table tr:hover {
  background: #faf8f5;
  cursor: pointer;
}
.s-table tr.planned-row { background: #fef9eb; }
.s-table tr.planned-row:hover { background: #fdf0d0; }

/* BADGES */
.badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}
.badge-auto { background: #e8f5e9; color: var(--forest); }
.badge-manual { background: #f0ece6; color: var(--greystone); }
.badge-pending { background: #fef9eb; color: var(--goldenrod-dark); }
.badge-planned {
  background: var(--goldenrod);
  color: var(--maroon);
  font-size: 10px;
  padding: 2px 8px;
  margin-left: 6px;
}
.risk-dot {
  display: inline-block;
  width: 28px; height: 28px;
  line-height: 28px;
  text-align: center;
  border-radius: 50%;
  font-size: 11px;
  font-weight: 700;
  color: #fff;
}
.risk-high { background: var(--brick); }
.risk-med { background: var(--goldenrod-dark); }
.risk-low { background: var(--ivy); }

/* DETAIL OVERLAY */
.detail-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4);
  z-index: 200;
  justify-content: center;
  align-items: start;
  padding: 40px;
}
.detail-overlay.open { display: flex; }
.detail-card {
  background: #fff;
  border-radius: 10px;
  width: 720px;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.25);
}
.detail-header {
  background: var(--maroon);
  color: #fff;
  padding: 20px 24px;
  border-radius: 10px 10px 0 0;
  position: relative;
}
.detail-header h2 {
  font-family: Georgia, serif;
  font-size: 18px;
  padding-right: 40px;
}
.detail-header .grp {
  font-size: 11px;
  color: var(--goldenrod);
  margin-bottom: 4px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.detail-close {
  position: absolute;
  top: 16px; right: 20px;
  background: none;
  border: none;
  color: #fff;
  font-size: 24px;
  cursor: pointer;
  opacity: 0.7;
}
.detail-close:hover { opacity: 1; }
.detail-body { padding: 24px; }
.detail-desc {
  font-size: 14px;
  color: var(--text-mid);
  margin-bottom: 20px;
  line-height: 1.5;
  padding: 12px 16px;
  background: #faf8f5;
  border-left: 3px solid var(--maroon);
  border-radius: 0 4px 4px 0;
}
.detail-section { margin-bottom: 20px; }
.detail-section h3 {
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--maroon);
  margin-bottom: 8px;
  padding-bottom: 4px;
  border-bottom: 1px solid var(--border);
}
.detail-steps {
  font-size: 13px;
  line-height: 1.7;
  color: var(--text-dark);
  white-space: pre-wrap;
  padding: 12px 16px;
  background: #faf8f5;
  border-radius: 6px;
}
.detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
.detail-field {
  padding: 10px 14px;
  background: #faf8f5;
  border-radius: 6px;
}
.detail-field .df-label {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-light);
  margin-bottom: 2px;
}
.detail-field .df-value {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-dark);
}
.detail-field a { color: var(--lake); text-decoration: none; }
.detail-field a:hover { text-decoration: underline; }
.detail-badges {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

/* STATES */
.loading {
  text-align: center;
  padding: 60px;
  font-size: 14px;
  color: var(--text-light);
}
.spinner {
  display: inline-block;
  width: 24px; height: 24px;
  border: 3px solid var(--border);
  border-top-color: var(--maroon);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  margin-bottom: 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.empty {
  text-align: center;
  padding: 40px;
  color: var(--text-light);
  font-size: 13px;
}
.error-msg {
  text-align: center;
  padding: 80px 32px;
  color: var(--brick);
}
.error-msg h2 {
  font-family: Georgia, serif;
  font-size: 20px;
  margin-bottom: 8px;
}
.error-msg p {
  font-size: 13px;
  color: var(--text-mid);
}
.footer {
  padding: 12px 32px;
  font-size: 10px;
  color: var(--text-light);
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
}

@media print {
  .header-actions, .btn-config, #configPanel, .risk-bar, .search-input, .filter-btn, .detail-overlay { display: none !important; }
}
@media (max-width: 900px) {
  .kpi-grid { grid-template-columns: repeat(2, 1fr); }
  .cat-grid { grid-template-columns: 1fr; }
  .detail-card { width: 95%; }
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-top">
    <div>
      <div class="header-tag">QA Test Management</div>
      <h1>Test Automation Dashboard</h1>
      <div class="header-sub">University of Chicago Advancement · Copado Robotic Testing (CRT)</div>
    </div>
    <div class="header-actions">
      <button class="btn btn-forest" onclick="openForm()">+ Add Scenario</button>
      <button class="btn btn-gold" onclick="loadData()">↻ Refresh</button>
      <button class="btn btn-config" onclick="document.getElementById('configPanel').classList.toggle('open')">⚙</button>
    </div>
  </div>
</div>

<!-- CONFIG -->
<div id="configPanel">
  <label>Baseline Goal:</label>
  <input type="number" id="cfgBaseline" value="60">
  <button class="btn btn-gold" onclick="renderAll()">Apply</button>
</div>

<!-- RISK FILTER BAR -->
<div class="risk-bar" id="riskBar">
  <span class="risk-bar-label">Risk Level:</span>
  <button class="risk-btn active" data-risk="high" onclick="setRiskFilter('high')">High (≥ 2.5)</button>
  <button class="risk-btn" data-risk="medium" onclick="setRiskFilter('medium')">Medium (1.75–2.49)</button>
  <button class="risk-btn" data-risk="low" onclick="setRiskFilter('low')">Low (&lt; 1.75)</button>
  <button class="risk-btn" data-risk="all" onclick="setRiskFilter('all')">All</button>
</div>

<!-- CONTENT -->
<div class="content" id="mainContent">
  <div class="loading"><div class="spinner"></div><br>Loading dashboard...</div>
</div>

<!-- FORM OVERLAY -->
<div class="detail-overlay" id="formOverlay" onclick="if(event.target===this)closeForm()">
  <div class="detail-card" style="width:800px;max-height:90vh;">
    <div class="detail-header">
      <span class="grp">New Submission</span>
      <h2>Add Scenario</h2>
      <button class="detail-close" onclick="closeForm()">✕</button>
    </div>
    <iframe id="formFrame" src="" style="width:100%;height:70vh;border:none;"></iframe>
  </div>
</div>

<!-- DETAIL OVERLAY -->
<div class="detail-overlay" id="detailOverlay" onclick="if(event.target===this)closeDetail()">
  <div class="detail-card">
    <div class="detail-header">
      <span class="grp" id="detGrp"></span>
      <h2 id="detTitle"></h2>
      <button class="detail-close" onclick="closeDetail()">✕</button>
    </div>
    <div class="detail-body" id="detBody"></div>
  </div>
</div>

<script>
/* ================================================================
   CONFIGURATION
   ================================================================ */
var SHEET_BASE = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRoGV-kjbZw4zZrS-zS3HWuqDf-bGuy4Cgi84V10UR6Np6ZhHZ-S27hhHVgVlV82IIY0ltQ9LuCzZEf/pub?output=csv';
var TAB_GIDS = ['0', '1486981684'];
var FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdiK9gR4gChrSv3VJzrKiJkzE0eu7IkobhoF9R4jCG5LlBSeg/viewform?embedded=true';

/* ================================================================
   STATE
   ================================================================ */
var RAW_DATA = [];
var DATA = [];
var FILTERED = [];
var ACTIVE_GROUP = 'All';
var SEARCH_TERM = '';
var SORT_COL = null;
var SORT_DIR = 1;
var RISK_FILTER = 'high';

var GROUP_COLORS = {
  'Alumni & Friends Portal': '#007396',
  'Constituent Management': '#59315F',
  'Gift Admin': '#275D38',
  'Prospect Research': '#EAAA00',
  'Events': '#DE7C00',
  'Marketing & Communication': '#789D4A',
  'Prospect Management/Gift Officer': '#A4343A'
};

function gc(group) { return GROUP_COLORS[group] || '#767676'; }

/* ================================================================
   CSV PARSER
   ================================================================ */
function parseCSV(text) {
  var lines = [];
  var current = '';
  var inQuotes = false;
  var row = [];
  for (var i = 0; i < text.length; i++) {
    var ch = text[i];
    var next = i + 1 < text.length ? text[i + 1] : '';
    if (inQuotes) {
      if (ch === '"' && next === '"') { current += '"'; i++; }
      else if (ch === '"') { inQuotes = false; }
      else { current += ch; }
    } else {
      if (ch === '"') { inQuotes = true; }
      else if (ch === ',') { row.push(current.trim()); current = ''; }
      else if (ch === '\n' || (ch === '\r' && next === '\n')) {
        if (ch === '\r') i++;
        row.push(current.trim());
        lines.push(row);
        row = [];
        current = '';
      } else { current += ch; }
    }
  }
  if (current || row.length > 0) { row.push(current.trim()); lines.push(row); }
  return lines;
}

function csvToObjects(text) {
  var lines = parseCSV(text);
  if (lines.length < 2) return [];
  var headers = [];
  for (var h = 0; h < lines[0].length; h++) {
    headers.push(lines[0][h].replace(/^\uFEFF/, '').trim());
  }
  var rows = [];
  for (var i = 1; i < lines.length; i++) {
    var r = lines[i];
    var empty = true;
    for (var k = 0; k < r.length; k++) { if (r[k]) { empty = false; break; } }
    if (empty) continue;
    var obj = {};
    for (var j = 0; j < headers.length; j++) {
      obj[headers[j]] = (j < r.length) ? r[j] : '';
    }
    rows.push(obj);
  }
  return rows;
}

/* ================================================================
   DATA LOADING
   ================================================================ */
function fetchWithFallback(url) {
  return fetch(url)
    .then(function(r) { if (!r.ok) throw new Error(); return r.text(); })
    .then(function(t) { if (!t || t.length < 10) throw new Error(); return t; })
    .catch(function() {
      return fetch('https://corsproxy.io/?' + encodeURIComponent(url))
        .then(function(r) { if (!r.ok) throw new Error(); return r.text(); })
        .then(function(t) { if (!t || t.length < 10) throw new Error(); return t; });
    })
    .catch(function() {
      return fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(url))
        .then(function(r) { if (!r.ok) throw new Error(); return r.text(); })
        .then(function(t) { if (!t || t.length < 10) throw new Error(); return t; });
    });
}

function loadData() {
  document.getElementById('mainContent').innerHTML = '<div class="loading"><div class="spinner"></div><br>Loading...</div>';
  var allRows = [];
  var promises = [];
  for (var i = 0; i < TAB_GIDS.length; i++) {
    var url = SHEET_BASE + '&gid=' + TAB_GIDS[i];
    promises.push(
      fetchWithFallback(url)
        .then(function(text) {
          var rows = csvToObjects(text);
          for (var r = 0; r < rows.length; r++) allRows.push(rows[r]);
        })
        .catch(function() {})
    );
  }
  Promise.all(promises).then(function() {
    if (allRows.length === 0) {
      return fetchWithFallback(SHEET_BASE)
        .then(function(text) {
          var rows = csvToObjects(text);
          for (var r = 0; r < rows.length; r++) allRows.push(rows[r]);
        })
        .catch(function() {});
    }
  }).then(function() {
    if (allRows.length === 0) {
      document.getElementById('mainContent').innerHTML =
        '<div class="error-msg"><h2>Could not load data</h2><p>Please check that the Google Sheet is published to web and try again.</p></div>';
      return;
    }
    var seen = {};
    RAW_DATA = [];
    for (var i = 0; i < allRows.length; i++) {
      var name = (allRows[i]['Process Name / User Story'] || '').trim().toLowerCase();
      if (name && seen[name]) continue;
      if (name) seen[name] = true;
      RAW_DATA.push(allRows[i]);
    }
    applyRiskFilter();
    renderAll();
  });
}

/* ================================================================
   HELPERS
   ================================================================ */
function gv(row, field) { return (row[field] || '').trim(); }
function getExec(r) { return gv(r, 'Execution'); }
function getGroup(r) { return gv(r, 'Group') || 'Unknown'; }
function getRisk(r) { return parseFloat(r['Risk Average']) || 0; }
function getStatus(r) { return gv(r, 'Status'); }
function getToDo(r) { return gv(r, 'To Do'); }
function isPlanned(r) { var v = gv(r, 'Planned').toLowerCase(); return v === 'true' || v === 'yes' || v === '1'; }
function pct(n, d) { return d === 0 ? 0 : Math.round((n / d) * 100); }
function riskClass(risk) { return risk >= 2.5 ? 'risk-high' : risk >= 1.75 ? 'risk-med' : 'risk-low'; }
function execBadge(ex) { return ex === 'Automated' ? 'badge-auto' : ex === 'Pending' ? 'badge-pending' : 'badge-manual'; }
function esc(str) { return (str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
function linkOrText(val, label) {
  if (!val) return '—';
  return val.indexOf('http') === 0 ? '<a href="' + val + '" target="_blank">' + (label || 'View') + '</a>' : esc(val);
}

/* ================================================================
   RISK FILTER (GLOBAL)
   ================================================================ */
function applyRiskFilter() {
  DATA = [];
  for (var i = 0; i < RAW_DATA.length; i++) {
    var risk = getRisk(RAW_DATA[i]);
    if (RISK_FILTER === 'high' && risk < 2.5) continue;
    if (RISK_FILTER === 'medium' && (risk < 1.75 || risk >= 2.5)) continue;
    if (RISK_FILTER === 'low' && risk >= 1.75) continue;
    DATA.push(RAW_DATA[i]);
  }
}

function setRiskFilter(level) {
  RISK_FILTER = level;
  ACTIVE_GROUP = 'All';
  SEARCH_TERM = '';
  applyRiskFilter();

  var btns = document.querySelectorAll('.risk-btn');
  for (var i = 0; i < btns.length; i++) {
    btns[i].className = btns[i].getAttribute('data-risk') === level ? 'risk-btn active' : 'risk-btn';
  }

  renderAll();
}

function calcStats() {
  var baseline = parseInt(document.getElementById('cfgBaseline').value) || 60;
  var automated = 0, manual = 0, pending = 0, planned = 0;
  var groups = {};
  for (var i = 0; i < DATA.length; i++) {
    var r = DATA[i];
    var g = getGroup(r);
    var ex = getExec(r);
    if (!groups[g]) groups[g] = { total: 0, automated: 0, manual: 0, pending: 0, planned: 0 };
    groups[g].total++;
    if (ex === 'Automated') { automated++; groups[g].automated++; }
    else if (ex === 'Manual') { manual++; groups[g].manual++; }
    else if (ex === 'Pending') { pending++; groups[g].pending++; }
    if (isPlanned(r)) { planned++; groups[g].planned++; }
  }
  return { baseline: baseline, total: DATA.length, automated: automated, manual: manual, pending: pending, planned: planned, pct: pct(automated, baseline), groups: groups };
}

/* ================================================================
   FILTERING & SORTING (LIST)
   ================================================================ */
function applyFilters() {
  FILTERED = [];
  for (var i = 0; i < DATA.length; i++) {
    var r = DATA[i];
    if (ACTIVE_GROUP !== 'All' && getGroup(r) !== ACTIVE_GROUP) continue;
    if (SEARCH_TERM) {
      var hay = [gv(r, 'Process Name / User Story'), gv(r, 'Group'), gv(r, 'Description'), gv(r, 'Status'), gv(r, 'Execution'), gv(r, 'To Do'), gv(r, 'Notes')].join(' ').toLowerCase();
      if (hay.indexOf(SEARCH_TERM.toLowerCase()) === -1) continue;
    }
    FILTERED.push(r);
  }
  if (SORT_COL) {
    FILTERED.sort(function(a, b) {
      var va = a[SORT_COL] || '', vb = b[SORT_COL] || '';
      var na = parseFloat(va), nb = parseFloat(vb);
      if (!isNaN(na) && !isNaN(nb)) return (na - nb) * SORT_DIR;
      return va.localeCompare(vb) * SORT_DIR;
    });
  }
}

function setGroup(g) {
  ACTIVE_GROUP = g;
  applyFilters();
  renderList();
  var btns = document.querySelectorAll('.filter-btn');
  for (var i = 0; i < btns.length; i++) {
    btns[i].className = btns[i].getAttribute('data-group') === g ? 'filter-btn active' : 'filter-btn';
  }
}

function setSearch(val) { SEARCH_TERM = val; applyFilters(); renderList(); }

function setSort(col) {
  if (SORT_COL === col) SORT_DIR *= -1;
  else { SORT_COL = col; SORT_DIR = 1; }
  applyFilters();
  renderList();
}

/* ================================================================
   RENDER DASHBOARD
   ================================================================ */
function renderAll() {
  var s = calcStats();
  applyFilters();
  var groupNames = Object.keys(s.groups).sort();
  var maxGrp = 1;
  for (var i = 0; i < groupNames.length; i++) {
    if (s.groups[groupNames[i]].total > maxGrp) maxGrp = s.groups[groupNames[i]].total;
  }

  var riskLabel = RISK_FILTER === 'all' ? 'All Risk Levels' : RISK_FILTER === 'high' ? 'High Risk (≥ 2.5)' : RISK_FILTER === 'medium' ? 'Medium Risk (1.75–2.49)' : 'Low Risk (< 1.75)';

  var h = '';

  // KPIs
  h += '<div class="kpi-grid">';
  h += '<div class="kpi"><div class="bar" style="background:var(--lake)"></div><div class="lbl">Total Scenarios</div><div class="val" style="color:var(--lake)">' + s.total + '</div><div class="sub">' + riskLabel + '</div></div>';
  h += '<div class="kpi"><div class="bar" style="background:var(--maroon)"></div><div class="lbl">Baseline Goal</div><div class="val" style="color:var(--maroon)">' + s.baseline + '</div><div class="sub">Target scenarios</div></div>';
  h += '<div class="kpi"><div class="bar" style="background:var(--forest)"></div><div class="lbl">Currently Automated</div><div class="val" style="color:var(--forest)">' + s.automated + '</div><div class="sub">' + s.pct + '% of baseline · ' + pct(s.automated, s.total) + '% of view</div></div>';
  h += '<div class="kpi"><div class="bar" style="background:var(--goldenrod)"></div><div class="lbl">Pipeline</div><div class="val" style="color:var(--goldenrod-dark)">' + (s.manual + s.pending) + '</div><div class="sub">' + s.manual + ' manual · ' + s.pending + ' pending · ' + s.planned + ' planned</div></div>';
  h += '</div>';

  // Progress
  var autoW = Math.min(pct(s.automated, s.total), 100);
  var pendW = Math.min(pct(s.automated + s.pending, s.total), 100) - autoW;
  h += '<div class="progress-panel"><div class="title">Automation Coverage — ' + riskLabel + ' (' + s.total + ' scenarios)</div>';
  h += '<div class="prog-label"><span><strong style="color:var(--forest)">' + s.automated + ' automated</strong> + ' + s.pending + ' pending of ' + s.total + ' in view</span><strong style="color:var(--forest)">' + pct(s.automated, s.total) + '%</strong></div>';
  h += '<div class="prog-track"><div class="prog-fill" style="width:' + autoW + '%;background:var(--forest)"></div><div class="prog-fill" style="width:' + pendW + '%;background:var(--goldenrod);opacity:0.5"></div></div>';
  h += '<div class="prog-legend"><span><i style="background:var(--forest)"></i>Automated</span><span><i style="background:var(--goldenrod);opacity:0.5"></i>Pending</span></div></div>';

  // Categories
  h += '<div class="cat-grid"><div class="cat-panel"><div class="title">Scenarios by Group</div>';
  for (var i = 0; i < groupNames.length; i++) {
    var g = groupNames[i], d = s.groups[g], c = gc(g);
    h += '<div class="cat-row"><div class="cat-lbl"><span style="color:' + c + ';font-weight:600">' + g + '</span><span>' + d.total + '</span></div>';
    h += '<div class="cat-track">';
    if (d.automated) h += '<div style="width:' + (d.automated / maxGrp * 90) + '%;background:' + c + ';border-radius:4px 0 0 4px"></div>';
    if (d.manual) h += '<div style="width:' + (d.manual / maxGrp * 90) + '%;background:' + c + '44"></div>';
    if (d.pending) h += '<div style="width:' + (d.pending / maxGrp * 90) + '%;background:' + c + '22;border-right:2px dashed ' + c + '"></div>';
    h += '</div></div>';
  }
  h += '<div class="cat-legend"><span><i style="background:var(--greystone)"></i>Automated</span><span><i style="background:rgba(118,118,118,0.27)"></i>Manual</span><span><i style="background:rgba(118,118,118,0.13);border:1px dashed var(--greystone)"></i>Pending</span></div></div>';

  h += '<div class="cat-panel"><div class="title">Automation Rate by Group</div>';
  for (var i = 0; i < groupNames.length; i++) {
    var g = groupNames[i], d = s.groups[g], c = gc(g);
    var rate = d.total > 0 ? Math.round((d.automated / d.total) * 100) : 0;
    var rc = rate >= 60 ? 'var(--forest)' : rate >= 30 ? 'var(--goldenrod-dark)' : 'var(--brick)';
    h += '<div class="cat-row"><div class="cat-lbl"><span style="color:' + c + ';font-weight:600">' + g + '</span><span style="font-weight:600;color:' + rc + '">' + rate + '%</span></div>';
    h += '<div class="cat-track"><div style="width:' + rate + '%;background:' + c + ';border-radius:4px;height:100%"></div></div></div>';
  }
  h += '</div></div>';

  // Scenario list
  var groupCounts = {};
  for (var i = 0; i < DATA.length; i++) { var g = getGroup(DATA[i]); groupCounts[g] = (groupCounts[g] || 0) + 1; }

  h += '<div class="list-section"><div class="list-toolbar">';
  h += '<input class="search-input" type="text" placeholder="Search scenarios..." oninput="setSearch(this.value)" value="' + SEARCH_TERM + '">';
  h += '<button class="filter-btn' + (ACTIVE_GROUP === 'All' ? ' active' : '') + '" data-group="All" onclick="setGroup(\'All\')">All<span class="ct">' + DATA.length + '</span></button>';
  for (var i = 0; i < groupNames.length; i++) {
    var g = groupNames[i];
    var escaped = g.replace(/'/g, "\\'");
    h += '<button class="filter-btn' + (ACTIVE_GROUP === g ? ' active' : '') + '" data-group="' + g + '" onclick="setGroup(\'' + escaped + '\')">' + g + '<span class="ct">' + (groupCounts[g] || 0) + '</span></button>';
  }
  h += '</div><div id="listBody"></div></div>';

  h += '<div class="footer"><span>Copado Robotic Testing (CRT) · Live from Google Sheets</span><span>' + new Date().toLocaleDateString() + '</span></div>';

  document.getElementById('mainContent').innerHTML = h;
  renderList();
}

/* ================================================================
   RENDER TABLE
   ================================================================ */
function renderList() {
  var body = document.getElementById('listBody');
  if (!body) return;
  if (FILTERED.length === 0) { body.innerHTML = '<div class="empty">No scenarios match your filters</div>'; return; }

  var arrow = function(col) { return SORT_COL === col ? (SORT_DIR === 1 ? ' ▲' : ' ▼') : ''; };

  var t = '<table class="s-table"><thead><tr>';
  t += '<th onclick="setSort(\'Process Name / User Story\')">Process Name' + arrow('Process Name / User Story') + '</th>';
  t += '<th onclick="setSort(\'Group\')">Group' + arrow('Group') + '</th>';
  t += '<th onclick="setSort(\'Execution\')">Execution' + arrow('Execution') + '</th>';
  t += '<th onclick="setSort(\'Risk Average\')">Risk' + arrow('Risk Average') + '</th>';
  t += '<th onclick="setSort(\'Status\')">Status' + arrow('Status') + '</th>';
  t += '<th onclick="setSort(\'To Do\')">To Do' + arrow('To Do') + '</th>';
  t += '<th onclick="setSort(\'Sprint\')">Sprint' + arrow('Sprint') + '</th>';
  t += '</tr></thead><tbody>';

  for (var i = 0; i < FILTERED.length; i++) {
    var r = FILTERED[i];
    var ex = getExec(r), risk = getRisk(r), pl = isPlanned(r);
    var sprint = gv(r, 'Sprint');
    var sd = sprint ? (sprint.indexOf('http') === 0 ? '<a href="' + sprint + '" target="_blank" onclick="event.stopPropagation()" style="color:var(--lake)">View</a>' : esc(sprint)) : '—';

    t += '<tr class="' + (pl ? 'planned-row' : '') + '" onclick="showDetail(' + i + ')">';
    t += '<td><strong>' + esc(gv(r, 'Process Name / User Story')) + '</strong>' + (pl ? '<span class="badge badge-planned">PLANNED</span>' : '') + '</td>';
    t += '<td style="color:' + gc(getGroup(r)) + ';font-weight:600;font-size:12px">' + esc(getGroup(r)) + '</td>';
    t += '<td><span class="badge ' + execBadge(ex) + '">' + (ex || '—') + '</span></td>';
    t += '<td><span class="risk-dot ' + riskClass(risk) + '">' + (risk || '—') + '</span></td>';
    t += '<td style="font-size:12px">' + (getStatus(r) || '—') + '</td>';
    t += '<td style="font-size:12px">' + (getToDo(r) || '—') + '</td>';
    t += '<td style="font-size:12px">' + sd + '</td></tr>';
  }
  t += '</tbody></table>';
  body.innerHTML = t;
}

/* ================================================================
   DETAIL VIEW
   ================================================================ */
function showDetail(idx) {
  var r = FILTERED[idx];
  if (!r) return;
  document.getElementById('detGrp').textContent = getGroup(r);
  document.getElementById('detTitle').textContent = gv(r, 'Process Name / User Story');

  var ex = getExec(r), risk = getRisk(r);
  var h = '';

  h += '<div class="detail-badges">';
  h += '<span class="badge ' + execBadge(ex) + '">' + (ex || '—') + '</span>';
  if (isPlanned(r)) h += '<span class="badge badge-planned">PLANNED</span>';
  h += '<span class="risk-dot ' + riskClass(risk) + '" style="font-size:10px;width:auto;padding:4px 10px;border-radius:12px;">Risk: ' + (risk || '—') + '</span>';
  h += '</div>';

  var desc = gv(r, 'Description');
  if (desc) h += '<div class="detail-desc">' + esc(desc) + '</div>';

  var steps = gv(r, 'Test Steps');
  if (steps) h += '<div class="detail-section"><h3>Test Steps</h3><div class="detail-steps">' + esc(steps) + '</div></div>';

  h += '<div class="detail-section"><h3>Risk Assessment</h3><div class="detail-grid">';
  h += '<div class="detail-field"><div class="df-label">Frequency of Use</div><div class="df-value">' + (gv(r, 'Frequency of Use') || '—') + '</div></div>';
  h += '<div class="detail-field"><div class="df-label">Business Impact</div><div class="df-value">' + (gv(r, 'Business Impact') || '—') + '</div></div>';
  h += '<div class="detail-field"><div class="df-label">Process Complexity</div><div class="df-value">' + (gv(r, 'Process Complexity') || '—') + '</div></div>';
  h += '<div class="detail-field"><div class="df-label">Technical Impact</div><div class="df-value">' + (gv(r, 'Technical Impact') || '—') + '</div></div>';
  h += '</div></div>';

  h += '<div class="detail-section"><h3>Workflow</h3><div class="detail-grid">';
  h += '<div class="detail-field"><div class="df-label">Status</div><div class="df-value">' + (getStatus(r) || '—') + '</div></div>';
  h += '<div class="detail-field"><div class="df-label">To Do</div><div class="df-value">' + (getToDo(r) || '—') + '</div></div>';
  h += '<div class="detail-field"><div class="df-label">Execution</div><div class="df-value">' + (ex || '—') + '</div></div>';
  h += '<div class="detail-field"><div class="df-label">Sprint</div><div class="df-value">' + linkOrText(gv(r, 'Sprint'), 'View Sprint') + '</div></div>';
  h += '</div></div>';

  var workId = gv(r, 'Work ID'), notes = gv(r, 'Notes');
  if (workId || notes) {
    h += '<div class="detail-section"><h3>References</h3><div class="detail-grid">';
    if (workId) h += '<div class="detail-field"><div class="df-label">Work ID</div><div class="df-value">' + linkOrText(workId, 'Open in CRT') + '</div></div>';
    if (notes) h += '<div class="detail-field"><div class="df-label">Notes</div><div class="df-value">' + esc(notes) + '</div></div>';
    h += '</div></div>';
  }

  document.getElementById('detBody').innerHTML = h;
  document.getElementById('detailOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeDetail() {
  document.getElementById('detailOverlay').classList.remove('open');
  document.body.style.overflow = '';
}

/* ================================================================
   FORM
   ================================================================ */
function openForm() {
  document.getElementById('formFrame').src = FORM_URL;
  document.getElementById('formOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeForm() {
  document.getElementById('formOverlay').classList.remove('open');
  document.getElementById('formFrame').src = '';
  document.body.style.overflow = '';
}

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeDetail();
    closeForm();
  }
});

/* Auto-load */
window.addEventListener('DOMContentLoaded', function() { loadData(); });
</script>
</body>
</html>
